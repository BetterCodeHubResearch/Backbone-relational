/**!
 * Backbone Relational v0.10.0 (backbone-relational)
 * ----------------------------------
 * (c) 2011-2016 Paul Uithol and contributors (https://github.com/PaulUithol/Backbone-relational/graphs/contributors)
 * Distributed under MIT license
 *
 * http://backbonerelational.org
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("backbone"),require("underscore")):"function"==typeof define&&define.amd?define(["backbone","underscore"],t):e.BackboneRelational=t(e.Backbone,e._)}(this,function(e,t){"use strict";var i="default"in e?e["default"]:e;t="default"in t?t["default"]:t;var o={_permitsAvailable:null,_permitsUsed:0,acquire:function(){if(this._permitsAvailable&&this._permitsUsed>=this._permitsAvailable)throw new Error("Max permits acquired");this._permitsUsed++},release:function(){if(0===this._permitsUsed)throw new Error("All permits released");this._permitsUsed--},isLocked:function(){return this._permitsUsed>0},setAvailablePermits:function(e){if(this._permitsUsed>e)throw new Error("Available permits cannot be less than used permits");this._permitsAvailable=e}},n=function(){this._queue=[]};t.extend(n.prototype,o,{_queue:null,add:function(e){this.isBlocked()?this._queue.push(e):e()},process:function(){var e=this._queue;for(this._queue=[];e&&e.length;)e.shift()()},block:function(){this.acquire()},unblock:function(){this.release(),this.isBlocked()||this.process()},isBlocked:function(){return this.isLocked()}});var s=new n,l=e.Model.extend,r=i.Events,a=function(){for(var e,t=arguments.length,i=Array(t),o=0;t>o;o++)i[o]=arguments[o];(e=this.initialize).call.apply(e,[this].concat(i))};t.extend(a.prototype,r),a.extend=l;var c={showWarnings:!0},h=c;h.Collection=i.Collection.extend(),h.Semaphore=o,h.BlockingQueue=n,h.eventQueue=s,h.Store=a.extend({initialize:function(){this._collections=[],this._reverseRelations=[],this._orphanRelations=[],this._subModels=[],this._modelScopes=[window]},initializeRelation:function(e,i,o){var n=t.isString(i.type)?h[i.type]||this.getObjectByName(i.type):i.type;if(n&&n.prototype instanceof h.Relation){new n(e,i,o)}else h.showWarnings&&"undefined"!=typeof console&&console.warn("Relation=%o; missing or invalid relation type!",i)},addModelScope:function(e){this._modelScopes.push(e)},removeModelScope:function(e){this._modelScopes=t.without(this._modelScopes,e)},addSubModels:function(e,t){this._subModels.push({superModelType:t,subModels:e})},setupSuperModel:function(e){t.find(this._subModels,function(i){return t.filter(i.subModels||[],function(t,o){var n=this.getObjectByName(t);return e===n?(i.superModelType._subModels[o]=e,e._superModel=i.superModelType,e._subModelTypeValue=o,e._subModelTypeAttribute=i.superModelType.prototype.subModelTypeAttribute,!0):void 0},this).length},this)},addReverseRelation:function(e){var i=t.any(this._reverseRelations,function(i){return t.all(e||[],function(e,t){return e===i[t]})});!i&&e.model&&e.type&&(this._reverseRelations.push(e),this._addRelation(e.model,e),this.retroFitRelation(e))},addOrphanRelation:function(e){var i=t.any(this._orphanRelations,function(i){return t.all(e||[],function(e,t){return e===i[t]})});!i&&e.model&&e.type&&this._orphanRelations.push(e)},processOrphanRelations:function(){t.each(this._orphanRelations.slice(0),function(e){var i=h.store.getObjectByName(e.relatedModel);i&&(this.initializeRelation(null,e),this._orphanRelations=t.without(this._orphanRelations,e))},this)},_addRelation:function(e,i){e.prototype.relations||(e.prototype.relations=[]),e.prototype.relations.push(i),t.each(e._subModels||[],function(e){this._addRelation(e,i)},this)},retroFitRelation:function(e){var t=this.getCollection(e.model,!1);t&&t.each(function(t){if(t instanceof e.model){new e.type(t,e)}},this)},getCollection:function(e,i){e instanceof h.Model&&(e=e.constructor);for(var o=e;o._superModel;)o=o._superModel;var n=t.find(this._collections,function(e){return e.model===o});return n||i===!1||(n=this._createCollection(o)),n},getObjectByName:function(e){var i=e.split("."),o=null;return t.find(this._modelScopes,function(e){return o=t.reduce(i||[],function(e,t){return e?e[t]:void 0},e),o&&o!==e?!0:void 0},this),o},_createCollection:function(e){var t;return e instanceof h.Model&&(e=e.constructor),e.prototype instanceof h.Model&&(t=new h.Collection,t.model=e,this._collections.push(t)),t},resolveIdForItem:function(e,i){var o=t.isString(i)||t.isNumber(i)?i:null;return null===o&&(i instanceof h.Model?o=i.id:t.isObject(i)&&(o=i[e.prototype.idAttribute])),o||0===o||(o=null),o},find:function(e,t){var i=this.resolveIdForItem(e,t),o=this.getCollection(e);if(o){var n=o.get(i);if(n instanceof e)return n}return null},register:function(e){var t=this.getCollection(e);if(t){var i=e.collection;t.add(e),e.collection=i}},checkId:function(e,t){var i=this.getCollection(e),o=i&&i.get(t);if(o&&e!==o)throw h.showWarnings&&"undefined"!=typeof console&&console.warn("Duplicate id! Old RelationalModel=%o, new RelationalModel=%o",o,e),new Error("Cannot instantiate more than one Backbone.Relational.Model with the same id per type!")},update:function(e){var t=this.getCollection(e);t.contains(e)||this.register(e),t._onModelEvent("change:"+e.idAttribute,e,t),e.trigger("relational:change:id",e,t)},unregister:function(e){var o,n;e instanceof i.Model?(o=this.getCollection(e),n=[e]):e instanceof h.Collection?(o=this.getCollection(e.model),n=t.clone(e.models)):(o=this.getCollection(e),n=t.clone(o.models)),t.each(n,function(e){this.stopListening(e),t.invoke(e.getRelations(),"stopListening")},this),t.contains(this._collections,e)?o.reset([]):t.each(n,function(e){o.get(e)?o.remove(e):o.trigger("relational:remove",e,o)},this)},reset:function(){this.stopListening(),t.each(this._collections,function(e){this.unregister(e)},this),this._collections=[],this._subModels=[],this._modelScopes=[window]}}),h.store=new h.Store,h.Relation=a.extend(o).extend({options:{createModels:!0,includeInJSON:!0,isAutoRelation:!1,autoFetch:!1,parse:!1},instance:null,key:null,keyContents:null,relatedModel:null,relatedCollection:null,reverseRelation:null,related:null,constructor:function(e,i,o){if(this.instance=e,i=t.isObject(i)?i:{},this.reverseRelation=t.defaults(i.reverseRelation||{},this.options.reverseRelation),this.options=t.defaults(i,this.options,h.Relation.prototype.options),this.reverseRelation.type=t.isString(this.reverseRelation.type)?h[this.reverseRelation.type]||h.store.getObjectByName(this.reverseRelation.type):this.reverseRelation.type,this.key=this.options.key,this.keySource=this.options.keySource||this.key,this.keyDestination=this.options.keyDestination||this.keySource||this.key,this.model=this.options.model||this.instance.constructor,this.relatedModel=this.options.relatedModel,t.isUndefined(this.relatedModel)&&(this.relatedModel=this.model),!t.isFunction(this.relatedModel)||this.relatedModel.prototype instanceof h.Model||(this.relatedModel=t.result(this,"relatedModel")),t.isString(this.relatedModel)&&(this.relatedModel=h.store.getObjectByName(this.relatedModel)),this.checkPreconditions()&&(!this.options.isAutoRelation&&this.reverseRelation.type&&this.reverseRelation.key&&h.store.addReverseRelation(t.defaults({isAutoRelation:!0,model:this.relatedModel,relatedModel:this.model,reverseRelation:this.options},this.reverseRelation)),e)){var n=this.keySource;n!==this.key&&t.isObject(this.instance.get(this.key))&&(n=this.key),this.setKeyContents(this.instance.get(n)),this.relatedCollection=h.store.getCollection(this.relatedModel),this.keySource!==this.key&&delete this.instance.attributes[this.keySource],this.instance._relations[this.key]=this,this.initialize(o),this.options.autoFetch&&this.instance.getAsync(this.key,t.isObject(this.options.autoFetch)?this.options.autoFetch:{}),this.listenTo(this.instance,"destroy",this.destroy).listenTo(this.relatedCollection,"relational:add relational:change:id",this.tryAddRelated).listenTo(this.relatedCollection,"relational:remove",this.removeRelated)}},checkPreconditions:function(){var e=this.instance,i=this.key,o=this.model,n=this.relatedModel,s=h.showWarnings&&"undefined"!=typeof console;if(!o||!i||!n)return s&&console.warn("Relation=%o: missing model, key or relatedModel (%o, %o, %o).",this,o,i,n),!1;if(!(o.prototype instanceof h.Model))return s&&console.warn("Relation=%o: model does not inherit from Backbone.Relational.Model (%o).",this,e),!1;if(!(n.prototype instanceof h.Model))return s&&console.warn("Relation=%o: relatedModel does not inherit from Backbone.Relational.Model (%o).",this,n),!1;if(this instanceof h.HasMany&&this.reverseRelation.type===h.HasMany)return s&&console.warn("Relation=%o: relation is a HasMany, and the reverseRelation is HasMany as well.",this),!1;if(e&&t.keys(e._relations).length){var l=t.find(e._relations,function(e){return e.key===i},this);if(l)return s&&console.warn("Cannot create relation=%o on %o for model=%o: already taken by relation=%o.",this,i,e,l),!1}return!0},setRelated:function(e){this.related=e,this.instance.attributes[this.key]=e},_isReverseRelation:function(e){return e.instance instanceof this.relatedModel&&this.reverseRelation.key===e.key&&this.key===e.reverseRelation.key},getReverseRelations:function(e){for(var i=[],o=t.isUndefined(e)?this.related&&(this.related.models||[this.related]):[e],n=null,s=null,l=0;l<(o||[]).length;l++){n=o[l].getRelations()||[];for(var r=0;r<n.length;r++)s=n[r],this._isReverseRelation(s)&&i.push(s)}return i},destroy:function(){this.stopListening(),this instanceof h.HasOne?this.setRelated(null):this instanceof h.HasMany&&this.setRelated(this._prepareCollection()),t.each(this.getReverseRelations(),function(e){e.removeRelated(this.instance)},this)}}),h.HasOne=h.Relation.extend({options:{reverseRelation:{type:"HasMany"}},initialize:function(e){this.listenTo(this.instance,"relational:change:"+this.key,this.onChange);var i=this.findRelated(e);this.setRelated(i),t.each(this.getReverseRelations(),function(t){t.addRelated(this.instance,e)},this)},findRelated:function(e){var i=null;if(e=t.defaults({parse:this.options.parse},e),this.keyContents instanceof this.relatedModel)i=this.keyContents;else if(this.keyContents||0===this.keyContents){var o=t.defaults({create:this.options.createModels},e);i=this.relatedModel.findOrCreate(this.keyContents,o)}return i&&(this.keyId=null),i},setKeyContents:function(e){this.keyContents=e,this.keyId=h.store.resolveIdForItem(this.relatedModel,this.keyContents)},onChange:function(e,i,o){if(!this.isLocked()){this.acquire(),o=o?t.clone(o):{};var n=t.isUndefined(o.__related),s=n?this.related:o.__related;if(n){this.setKeyContents(i);var l=this.findRelated(o);this.setRelated(l)}if(s&&this.related!==s&&t.each(this.getReverseRelations(s),function(e){e.removeRelated(this.instance,null,o)},this),t.each(this.getReverseRelations(),function(e){e.addRelated(this.instance,o)},this),!o.silent&&this.related!==s){var r=this;this.changed=!0,h.eventQueue.add(function(){r.instance.trigger("change:"+r.key,r.instance,r.related,o,!0),r.changed=!1})}this.release()}},tryAddRelated:function(e,t,i){!this.keyId&&0!==this.keyId||e.id!==this.keyId||(this.addRelated(e,i),this.keyId=null)},addRelated:function(e,i){var o=this;e.queue(function(){if(e!==o.related){var n=o.related||null;o.setRelated(e),o.onChange(o.instance,e,t.defaults({__related:n},i))}})},removeRelated:function(e,i,o){if(this.related&&e===this.related){var n=this.related||null;this.setRelated(null),this.onChange(this.instance,e,t.defaults({__related:n},o))}}}),h.HasMany=h.Relation.extend({collectionType:null,options:{reverseRelation:{type:"HasOne"},collectionType:h.Collection,collectionKey:!0,collectionOptions:{}},initialize:function(e){if(this.listenTo(this.instance,"relational:change:"+this.key,this.onChange),this.collectionType=this.options.collectionType,!t.isFunction(this.collectionType)||this.collectionType===h.Collection||this.collectionType.prototype instanceof h.Collection||(this.collectionType=t.result(this,"collectionType")),t.isString(this.collectionType)&&(this.collectionType=h.store.getObjectByName(this.collectionType)),this.collectionType!==h.Collection&&!(this.collectionType.prototype instanceof h.Collection))throw new Error("`collectionType` must inherit from module.Collection");var i=this.findRelated(e);this.setRelated(i)},_prepareCollection:function(e){if(this.related&&this.stopListening(this.related),!(e&&e instanceof h.Collection)){var i=t.isFunction(this.options.collectionOptions)?this.options.collectionOptions(this.instance):this.options.collectionOptions;e=new this.collectionType(null,i)}if(e.model=this.relatedModel,this.options.collectionKey){var o=this.options.collectionKey===!0?this.options.reverseRelation.key:this.options.collectionKey;e[o]&&e[o]!==this.instance?h.showWarnings&&"undefined"!=typeof console&&console.warn("Relation=%o; collectionKey=%s already exists on collection=%o",this,o,this.options.collectionKey):o&&(e[o]=this.instance)}return this.listenTo(e,"relational:add",this.handleAddition).listenTo(e,"relational:remove",this.handleRemoval).listenTo(e,"relational:reset",this.handleReset),e},findRelated:function(e){var i=null;if(e=t.defaults({parse:this.options.parse},e),this.keyContents instanceof h.Collection)this._prepareCollection(this.keyContents),i=this.keyContents;else{var o=[];t.each(this.keyContents,function(i){var n=null;n=i instanceof this.relatedModel?i:t.isObject(i)&&e.parse&&this.relatedModel.prototype.parse?this.relatedModel.prototype.parse(t.clone(i),e):i,n&&o.push(n)},this),i=this.related instanceof h.Collection?this.related:this._prepareCollection(),i.set(o,t.defaults({parse:!1},e))}return this.keyIds=t.difference(this.keyIds,t.pluck(i.models,"id")),i},setKeyContents:function(e){this.keyContents=e instanceof h.Collection?e:null,this.keyIds=[],this.keyContents||!e&&0!==e||(this.keyContents=t.isArray(e)?e:[e],t.each(this.keyContents,function(e){var t=h.store.resolveIdForItem(this.relatedModel,e);(t||0===t)&&this.keyIds.push(t)},this))},onChange:function(e,i,o){o=o?t.clone(o):{},this.setKeyContents(i),this.changed=!1;var n=this.findRelated(o);if(this.setRelated(n),!o.silent){var s=this;h.eventQueue.add(function(){s.changed&&(s.instance.trigger("change:"+s.key,s.instance,s.related,o,!0),s.changed=!1)})}},handleAddition:function(e,i,o){o=o?t.clone(o):{},this.changed=!0,t.each(this.getReverseRelations(e),function(e){e.addRelated(this.instance,o)},this);var n=this;!o.silent&&h.eventQueue.add(function(){n.instance.trigger("add:"+n.key,e,n.related,o)})},handleRemoval:function(e,i,o){o=o?t.clone(o):{},this.changed=!0,t.each(this.getReverseRelations(e),function(e){e.removeRelated(this.instance,null,o)},this);var n=this;!o.silent&&h.eventQueue.add(function(){n.instance.trigger("remove:"+n.key,e,n.related,o)})},handleReset:function(e,i){var o=this;i=i?t.clone(i):{},!i.silent&&h.eventQueue.add(function(){o.instance.trigger("reset:"+o.key,o.related,i)})},tryAddRelated:function(e,i,o){var n=t.contains(this.keyIds,e.id);n&&(this.addRelated(e,o),this.keyIds=t.without(this.keyIds,e.id))},addRelated:function(e,i){var o=this;e.queue(function(){o.related&&!o.related.get(e)&&o.related.add(e,t.defaults({parse:!1},i))})},removeRelated:function(e,t,i){this.related.get(e)&&this.related.remove(e,i)}}),h.Model=i.Model.extend(o).extend({relations:null,_relations:null,_isInitialized:!1,_deferProcessing:!1,_queue:null,_attributeChangeFired:!1,subModelTypeAttribute:"type",subModelTypes:null,constructor:function(e,o){if(o&&o.collection){var n=this,s=this.collection=o.collection;delete o.collection,this._deferProcessing=!0;var l=function r(e){e===n&&(n._deferProcessing=!1,n.processQueue(),s.off("relational:add",r))};s.on("relational:add",l),t.defer(function(){l(n)})}h.store.processOrphanRelations(),h.store.listenTo(this,"relational:unregister",h.store.unregister),this._queue=new h.BlockingQueue,this._queue.block(),h.eventQueue.block();try{i.Model.apply(this,arguments)}finally{h.eventQueue.unblock()}},trigger:function(e){if(e.length>5&&0===e.indexOf("change")){var t=this,o=arguments;h.eventQueue.isLocked()?h.eventQueue.add(function(){var n=!0;if("change"===e)n=t.hasChanged()||t._attributeChangeFired,t._attributeChangeFired=!1;else{var s=e.slice(7),l=t.getRelation(s);l?(n=o[4]===!0,n?t.changed[s]=o[2]:l.changed||delete t.changed[s]):n&&(t._attributeChangeFired=!0)}n&&i.Model.prototype.trigger.apply(t,o)}):i.Model.prototype.trigger.apply(t,o)}else"destroy"===e?(i.Model.prototype.trigger.apply(this,arguments),h.store.unregister(this)):i.Model.prototype.trigger.apply(this,arguments);return this},initializeRelations:function(e){this.acquire(),this._relations={},t.each(this.relations||[],function(t){h.store.initializeRelation(this,t,e)},this),this._isInitialized=!0,this.release(),this.processQueue()},updateRelations:function(e,i){this._isInitialized&&!this.isLocked()&&t.each(this._relations,function(t){if(!e||t.keySource in e||t.key in e){var o=this.attributes[t.keySource]||this.attributes[t.key],n=e&&(e[t.keySource]||e[t.key]);(t.related!==o||null===o&&null===n)&&this.trigger("relational:change:"+t.key,this,o,i||{})}t.keySource!==t.key&&delete this.attributes[t.keySource]},this)},queue:function(e){this._queue.add(e)},processQueue:function(){this._isInitialized&&!this._deferProcessing&&this._queue.isBlocked()&&this._queue.unblock()},getRelation:function(e){return this._relations[e]},getRelations:function(){return t.values(this._relations)},getIdsToFetch:function(e,i){var o=e instanceof h.Relation?e:this.getRelation(e),n=o?o.keyIds&&o.keyIds.slice(0)||(o.keyId||0===o.keyId?[o.keyId]:[]):[];if(i){var s=o.related&&(o.related.models||[o.related]);t.each(s,function(e){(e.id||0===e.id)&&n.push(e.id)})}return n},getAsync:function(e,o){o=t.extend({add:!0,remove:!1,refresh:!1},o);var n=this,s=[],l=this.getRelation(e),r=l&&this.getIdsToFetch(l,o.refresh),a=l.related instanceof h.Collection?l.related:l.relatedCollection;if(r&&r.length){var c,d=[],u=[],p=function(){d=t.map(r,function(e){var t=l.relatedModel.findModel(e);if(!t){var i={};i[l.relatedModel.prototype.idAttribute]=e,t=l.relatedModel.findOrCreate(i,o),u.push(t)}return t},this)};if(a instanceof h.Collection&&t.isFunction(a.url)){var f=a.url();c=a.url(r),c===f&&(p(),c=a.url(d),c===f&&(c=null))}if(c){var y=t.defaults({error:function(){t.each(u,function(e){e.trigger("destroy",e,e.collection,o)}),o.error&&o.error.apply(d,arguments)},url:c},o);s=[a.fetch(y)]}else d.length||p(),s=t.map(d,function(e){var i=t.defaults({error:function(){t.contains(u,e)&&e.trigger("destroy",e,e.collection,o),o.error&&o.error.apply(d,arguments)}},o);return e.fetch(i)},this)}return this.deferArray(s).then(function(){return i.Model.prototype.get.call(n,e)})},deferArray:function(e){return i.$.when.apply(null,e)},set:function(e,o,n){h.eventQueue.block();var s,l;t.isObject(e)||null==e?(s=e,n=o):(s={},s[e]=o);try{var r=this.id,a=s&&this.idAttribute in s&&s[this.idAttribute];h.store.checkId(this,a),l=i.Model.prototype.set.apply(this,arguments),this._isInitialized||this.isLocked()?a&&a!==r&&h.store.update(this):(this.constructor.initializeModelHierarchy(),(a||0===a)&&h.store.register(this),this.initializeRelations(n)),s&&this.updateRelations(s,n)}finally{h.eventQueue.unblock()}return l},clone:function(){var e=t.clone(this.attributes);return t.isUndefined(e[this.idAttribute])||(e[this.idAttribute]=null),t.each(this.getRelations(),function(t){delete e[t.key]}),new this.constructor(e)},toJSON:function(e){if(this.isLocked())return this.id;this.acquire();var o=i.Model.prototype.toJSON.call(this,e);return!this.constructor._superModel||this.constructor._subModelTypeAttribute in o||(o[this.constructor._subModelTypeAttribute]=this.constructor._subModelTypeValue),t.each(this._relations,function(n){var s=o[n.key],l=n.options.includeInJSON,r=null;l===!0?s&&t.isFunction(s.toJSON)&&(r=s.toJSON(e)):t.isString(l)?(s instanceof h.Collection?r=s.pluck(l):s instanceof i.Model&&(r=s.get(l)),l===n.relatedModel.prototype.idAttribute&&(n instanceof h.HasMany?r=r.concat(n.keyIds):n instanceof h.HasOne&&(r=r||n.keyId,r||t.isObject(n.keyContents)||(r=n.keyContents||null)))):t.isArray(l)?s instanceof h.Collection?(r=[],s.each(function(e){var i={};t.each(l,function(t){i[t]=e.get(t)}),r.push(i)})):s instanceof i.Model&&(r={},t.each(l,function(e){r[e]=s.get(e)})):delete o[n.key],null===r&&e&&e.wait&&(r=s),l&&(o[n.keyDestination]=r),n.keyDestination!==n.key&&delete o[n.key]}),this.release(),o}},{setup:function(e){return this.prototype.relations=(this.prototype.relations||[]).slice(0),this._subModels={},this._superModel=null,this.prototype.hasOwnProperty("subModelTypes")?h.store.addSubModels(this.prototype.subModelTypes,this):this.prototype.subModelTypes=null,t.each(this.prototype.relations||[],function(e){if(e.model||(e.model=this),e.reverseRelation&&e.model===this){var i=!0;if(t.isString(e.relatedModel)){var o=h.store.getObjectByName(e.relatedModel);i=o&&o.prototype instanceof h.Model}i?h.store.initializeRelation(null,e):t.isString(e.relatedModel)&&h.store.addOrphanRelation(e)}},this),this},build:function(e,t){this.initializeModelHierarchy();var i=this._findSubModelType(this,e)||this;return new i(e,t)},_findSubModelType:function(e,t){if(e._subModels&&e.prototype.subModelTypeAttribute in t){var i=t[e.prototype.subModelTypeAttribute],o=e._subModels[i];if(o)return o;for(i in e._subModels)if(o=this._findSubModelType(e._subModels[i],t))return o}return null},initializeModelHierarchy:function(){if(this.inheritRelations(),this.prototype.subModelTypes){var e=t.keys(this._subModels),i=t.omit(this.prototype.subModelTypes,e);t.each(i,function(e){var t=h.store.getObjectByName(e);t&&t.initializeModelHierarchy()})}},inheritRelations:function(){if(t.isUndefined(this._superModel)||t.isNull(this._superModel))if(h.store.setupSuperModel(this),this._superModel){if(this._superModel.inheritRelations(),this._superModel.prototype.relations){var e=t.filter(this._superModel.prototype.relations||[],function(e){return!t.any(this.prototype.relations||[],function(t){return e.relatedModel===t.relatedModel&&e.key===t.key},this)},this);this.prototype.relations=e.concat(this.prototype.relations)}}else this._superModel=!1},findOrCreate:function(e,i){i||(i={});var o=t.isObject(e)&&i.parse&&this.prototype.parse?this.prototype.parse(t.clone(e),i):e,n=this.findModel(o);return t.isObject(e)&&(n&&i.merge!==!1?(delete i.collection,delete i.url,n.set(o,i)):n||i.create===!1||(n=this.build(o,t.defaults({parse:!1},i)))),n},find:function(e,t){return t||(t={}),t.create=!1,this.findOrCreate(e,t)},findModel:function(e){return h.store.find(this,e)}}),h.Collection.prototype.__prepareModel=h.Collection.prototype._prepareModel,h.Collection.prototype._prepareModel=function(e,o){var n;return e instanceof i.Model?(e.collection||(e.collection=this),n=e):(o=o?t.clone(o):{},o.collection=this,n="undefined"!=typeof this.model.findOrCreate?this.model.findOrCreate(e,o):new this.model(e,o),n&&n.validationError&&(this.trigger("invalid",this,e,o),n=!1)),n};var d=h.Collection.prototype.__set=h.Collection.prototype.set;h.Collection.prototype.set=function(e,o){if(!(this.model.prototype instanceof h.Model))return d.call(this,e,o);o&&o.parse&&(e=this.parse(e,o));var n=!t.isArray(e),s=[],l=[],r=null;e=n?e?[e]:[]:t.clone(e);for(var a=0;a<e.length;a++)r=e[a],r instanceof i.Model||(r=h.Collection.prototype._prepareModel.call(this,r,o)),r&&(l.push(r),this.get(r)||this.get(r.cid)?null!=r.id&&(this._byId[r.id]=r):s.push(r));l=n?l.length?l[0]:null:l;var c=d.call(this,l,t.defaults({merge:!1,parse:!1},o));for(a=0;a<s.length;a++)r=s[a],(this.get(r)||this.get(r.cid))&&this.trigger("relational:add",r,this,o);return c};var u=i.Collection.prototype.___removeModels=i.Collection.prototype._removeModels;i.Collection.prototype._removeModels=function(e,i){if(!(this.model.prototype instanceof h.Model))return u.call(this,e,i);var o=[];t.each(e,function(e){e=this.get(e)||e&&this.get(e.cid),e&&o.push(e)},this);var n=u.call(this,o,i);return t.each(o,function(e){this.trigger("relational:remove",e,this,i)},this),n};var p=h.Collection.prototype.__reset=h.Collection.prototype.reset;h.Collection.prototype.reset=function(e,i){i=t.extend({merge:!0},i);var o=p.call(this,e,i);return this.model.prototype instanceof h.Model&&this.trigger("relational:reset",this,i),o};var f=h.Collection.prototype.__sort=h.Collection.prototype.sort;h.Collection.prototype.sort=function(e){var t=f.call(this,e);return this.model.prototype instanceof h.Model&&this.trigger("relational:reset",this,e),t};var y=h.Collection.prototype.__trigger=h.Collection.prototype.trigger;return h.Collection.prototype.trigger=function(e){if(!(this.model.prototype instanceof h.Model))return y.apply(this,arguments);if("add"===e||"remove"===e||"reset"===e||"sort"===e){var i=this,o=arguments;t.isObject(o[3])&&(o=t.toArray(o),o[3]=t.clone(o[3])),h.eventQueue.add(function(){y.apply(i,o)})}else y.apply(this,arguments);return this},h.Model.extend=function(e,t){var o=i.Model.extend.apply(this,arguments);return o.setup(this),o},h});
//# sourceMappingURL=backbone-relational.min.js.map
